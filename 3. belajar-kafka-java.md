# 6 juni 2024
## Mengatur routing pada message
pada kesempatan kali ini, melanjutkan dari pengiriman message dari producer ke comsumer, terdapat kondisi dimana message hanya dikirim ke partisi yang sama meskipun sudah diatur bahwa topik tersebut memiliki beberapa partisi. dalam implementasinya menjadikan satu consumer yang berada dalam grup costumer bisa menerima semua messagenya sendirian sementara costumer yang lainnya tidak menerima pesan sama sekali.
untuk menangani hal tersebut, ditambahkan routing untuk mengatur kedalam partisi mana message akan dikirim sehingga tidak hanya disimpan dalam sati partisi yang sama.

Berbeda dengan database dimana terdapat primary key yang bentuknya unik, key dalam kafka dapat sama dan digunakan untuk mengatur dimana partisi yang dipilih. Cara menentukannya yaitu melalui hash(message.key) % total partisi. misal dalam contoh dibawah saya membuat topic latihanjava yang mana diatur terdapat 2 partisi. saya menggunakan key "1", maka cara mengolahnya yaitu hash(1)%2. jadi dengan key yang sama, maka message akan selalu masuk kedalam partisi yang sama.

Dalam penerapannya, sebenarnya secara default, kafka akan mengatur key pada null/kosong, karena itulah mengapa pada kasus sebelumnya pesan selalu masuk ke 1 consumer saja dikarenakan masuk ke partisi 0 selalu. 

### console Producer
Cara mengatur key dapat menambahkan parameter `--property "parse.key=true" --property "key.separator=:"`

Dari parameter tersebut menunjukan bahwa penggunaan key akan diterapkan dengan pemisah antara key dan messagenya menggunakan tanda `":"`.

### console Consumer
pada bagian consumer, dapat ditambahkan parameter --property "print.key=true" untuk mencetak key yang digunakan guna memvalidasinya nanti.

### praktek
Dimulai dengan mencoba produce data tanpa parameter `--property "parse.key=true" --property "key.separator=:"` dahulu.
```
/opt/kafka_2.13-3.7.0/bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic latihanjava
```
![image](https://github.com/ferdyansahalfariz/belajar-linux/assets/96871156/cc79ae9a-127f-4407-ac7c-f0cd8d26bde5)
cek melalui consumer, disini saya menggunakan 3 consumer dalam group yang sama yaitu "belajar" dengan command:
```
/opt/kafka_2.13-3.7.0/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic latihanjava --group belajar --from-beginning --property "print.key=true"
```
![image](https://github.com/ferdyansahalfariz/belajar-linux/assets/96871156/243e30b6-b9cd-4d70-865a-74e01b4e24c2)
dari pesan tersebut, message hanya terkirim ke 1 customer saja dengan key null

Selanjutnya tambahkan parameter `--property "parse.key=true" --property "key.separator=:"` pada producer dan coba kirim pesan dengan format `"key:message"` seperti berikut:
![image](https://github.com/ferdyansahalfariz/belajar-linux/assets/96871156/7d5f478c-f05a-4af1-a10b-daa899b22fc9)
dapat dilihat pada consumer 1 diterima pesan berikut:
![image](https://github.com/ferdyansahalfariz/belajar-linux/assets/96871156/cf488627-77db-47a3-afec-3606218e808f)
untuk consumer 2 berikut:
![image](https://github.com/ferdyansahalfariz/belajar-linux/assets/96871156/83874adf-b9bd-422d-a120-3bdfdc06b967)
dan consumer 3 tidak menerima message apapun.

Kemudian saya coba untuk stop consumer 1 dan melanjutkan produce data lagi. dapat terlihat bahwa consumer 3 menggantikan consumer 1 untuk menerima message dan message dapat terbagi diantara consumer 2 dan 3 sesuai dengan perbedaan partisi yang ditempati berdasarkan key yang sudah diatur saat message di produce.
![image](https://github.com/ferdyansahalfariz/belajar-linux/assets/96871156/d1c87e43-b3a8-47d9-b2c0-dae4a7ac39ac)


# Membuat producer dan consumer melalui java.
1. untuk membuat producer dan consumer dengan java, diperlukan maven sebagai compilernya sehingga menghasilkan hasil akhir berupa jar yang nantinya dapat di run sebagai aplikasi producer dan consumer kafka. pastikan sudah menginstall maven, jika belum maka lakukan perintah berikut:
```
cd /opt
sudo wget https://downloads.apache.org/maven/maven-3/3.8.8/binaries/apache-maven-3.8.8-bin.tar.gz
sudo tar -xvzf apache-maven-3.8.8-bin.tar.gz
sudo mv apache-maven-3.8.8 maven
```
lakukan konfigurasi dengan membuka fie:
```
sudo nano /etc/profile.d/maven.sh
```
tambahkan baris berikut ke dalam filenya dan ctrl+o, enter dan ctrl+x untuk simpan dan keluar.
```
export M2_HOME=/opt/maven
export PATH=${M2_HOME}/bin:${PATH}
```
terapkan konfigurasinya dengan command:
```
source /etc/profile.d/maven.sh
```
validasi maven dengan `mvn -v`.

2. jika maven sudah terinstall, buat direktori baru untuk menyimpan projek java, disini saya membuat folder berikut untuk meletakan file ProducerApp.java dan ConsumerApp.java.

sebagai konfigurasinya, buat file pom.xml dengan isi sebagai berikut:
```
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>com.example</groupId>
    <artifactId>kafka-producer-consumer</artifactId>
    <version>1.0-SNAPSHOT</version>

    <properties>
        <maven.compiler.source>11</maven.compiler.source>
        <maven.compiler.target>11</maven.compiler.target>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.apache.kafka</groupId>
            <artifactId>kafka-clients</artifactId>
            <version>2.8.0</version>
        </dependency>

    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-compiler-plugin</artifactId>
                    <version>3.8.1</version>
                    <configuration>
                        <source>${maven.compiler.source}</source>
                        <target>${maven.compiler.target}</target>
                    </configuration>
                </plugin>
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-shade-plugin</artifactId>
                    <version>3.2.4</version>
                    <executions>
                </executions>
            </plugin>
        </plugins>
    </build>
</project>
```
3. Untuk ProducerApp.java dan ConsumerApp.java buat masing masing di dalam direktori berikut:
```
kafka-producer-consumer/src/main/java/com/example
```
untuk ProcedurApp.java memiliki isi sebagai berikut yang mengatur message dengan key berurut, serta value berupa JSON dan dilakukan sebanyak 5 perulangan:
```
package com.example;

import org.apache.kafka.clients.producer.KafkaProducer;
import org.apache.kafka.clients.producer.ProducerConfig;
import org.apache.kafka.clients.producer.ProducerRecord;
import org.apache.kafka.common.serialization.StringSerializer;

import java.util.Properties;
import java.util.concurrent.ExecutionException;

public class ProducerApp {

    public static void main(String[] args) throws ExecutionException, InterruptedException {
        Properties properties = new Properties();
        properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
        properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());

        KafkaProducer<String, String> producer = new KafkaProducer<>(properties);

        for (int i = 0; i < 5; i++) {
            String jsonMessage = "{"
                    + "\"id\":" + (i + 1) + ","
                    + "\"name\":\"ferdy " + (i + 1) + "\","
                    + "\"email\":\"ferdy" + (i + 1) + "@example.com\""
                    + "}";

            ProducerRecord<String, String> message = new ProducerRecord<>("java", Integer.toString(i), jsonMessage);
            producer.send(message).get();
        }

        producer.close();
    }
}
```
untuk ConsumerApp.java berisi:
```
package com.example;

import org.apache.kafka.clients.consumer.ConsumerConfig;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.clients.consumer.ConsumerRecords;
import org.apache.kafka.clients.consumer.KafkaConsumer;
import org.apache.kafka.common.serialization.StringDeserializer;

import java.time.Duration;
import java.util.Collections;
import java.util.Properties;
import java.util.List;

public class ConsumerApp {

    public static void main(String[] args) {
        Properties properties = new Properties();
        properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        properties.put(ConsumerConfig.GROUP_ID_CONFIG, "java");
        properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());
        properties.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");

        KafkaConsumer<String, String> consumer = new KafkaConsumer<>(properties);
        consumer.subscribe(List.of("java"));

        while (true) {
            ConsumerRecords<String, String> records = consumer.poll(Duration.ofSeconds(1));
            for (ConsumerRecord<String, String> record : records) {
                System.out.println("Message diterima: key: "+record.key() + " value: " +  record.value()+ " partisi: "+$            }
        }
    }
}
```
4. Setelah semuanya sudah dibuat, compile menggunakan maven sampai menghasilkan file jar dengan perintah:
```
mvn clean package
```
![image](https://github.com/ferdyansahalfariz/belajar-linux/assets/96871156/d1380b75-ebef-4207-b204-1e4d456a9e60
hasil yang di dapat berupa file berikut yang ada dalam direktori target:
```
kafka-producer-consumer-1.0-SNAPSHOT.jar
```
5. Run masing-masing aplikasinya baik producer ataupun consumer dengan perintah masing-masing:
```
java -cp kafka-producer-consumer/target/kafka-producer-consumer-1.0-SNAPSHOT.jar com.example.ConsumerApp
```
```
java -cp kafka-producer-consumer/target/kafka-producer-consumer-1.0-SNAPSHOT.jar com.example.ProducerApp
```
6. Pengetesan dilakukan dengan running 2 aplikasi consumer dan 1 aplikasi producer. dapat dilihat bahwa aplikasi berjalan normal dan message dapat terbagi partisinya sesuai dengan key. dapat dilihat pada gambar dibawah:

![image](https://github.com/ferdyansahalfariz/belajar-linux/assets/96871156/be9d9569-4f50-4d3b-a2d6-d4d28d7311f2)


